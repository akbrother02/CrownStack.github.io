<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="VikwqTxe7ybu1qSM7LFgIQpvHLN0_j-iVzaLqF88vEw" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matt Swanson - Durable Android REST Clients</title>
  <meta name="author" content="Matt Swanson" />
  <meta name="description" content="writing on software, book writeups and projects by a software engineer from Indianapolis" />
  
  <link rel="canonical" href="http://mdswanson.com/blog/2014/04/07/durable-android-rest-clients.html" />

  <link href="//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Matt Swanson's Blog" href="http://localhost:4000/atom.xml" />

  
    <link rel="stylesheet" href="/css/site.css">
  
</head>
<body>
  <section>
    <header class="navigation">
  <a href="/" class="logo" title="ÄLG, a solitary moose.">
    <img src="/static/moose.png" alt="Moose">
  </a>
  <nav>
    <ul>
      <li><a href="/">writing</a></li>
      <li><a href="/archive">archive</a></li>
      <li><a href="/about">about</a></li>
      <li class="no-bullet"><a href="/atom.xml">rss</a></li>
    </ul>
  </nav>
</header>

<article>
  <h1 class="title">
    Durable Android REST Clients
  </h1>

  
  <p class="subtitle">
    
      <span>
        
          Series:
          
            
              <a href="/#android">android</a>
            
          
        
      </span>

      <span class="date">
        April 07, 2014
      </span>
    
  </p>

  <div id="post"><p>For something as common as interfacing with a REST API, one would think that
there would be tons of great information about best practices for Android.</p>

<p>Maybe I’m not looking under the right rocks, because I certainly haven’t found
much. If you stick to the official Android docs, you will be immersed in a world
of components with names like <code class="highlighter-rouge">AsyncTask</code>, <code class="highlighter-rouge">ContentProvider</code>,
<code class="highlighter-rouge">BroadcastReceivers</code>, and <code class="highlighter-rouge">Loaders</code>. Are these components still widely-used
outside of Google? Should I trudge through the unfriendly APIs of Android or
look elsewhere?</p>

<p>If you dig a bit deeper, you may find a mystical link to a
<a href="https://www.youtube.com/watch?v=xHXn3Kg2IQE">four-year old Google I/O talk</a> that represents the “gold-standard”. Is this
approach still relevant? It looks like a lot of code, are their any sample apps
or do I just piece together everything from the PowerPoint slides? Surely the
APIs have changed since 2009, right?</p>

<p>Head on over to the third-party blogs and tutorials and get ready to try to make
sense of things like “non-UI retained Fragments” and “service binding”. Maybe I
have just not spent enough time immersed in the Android SDK, but I find it
incredibly difficult to understand some of these concepts.</p>

<p>This post will discuss the first steps of adding durability to your Android REST
clients: moving network requests outside of the Activity lifecycle. As an added
bonus, I find this approach to generate clear, understandable, and testable code
that will not explode if the user <em>gasp</em> rotates their phone.</p>

<p>My approach is not perfect and I will highlight areas for improvement at the end
of the post. My views have been heavily influenced by this <a href="http://birbit.com/a-recipe-for-writing-responsive-rest-clients-on-android/">enlightening
post</a> by <a href="https://twitter.com/yigitboyar">Yigit Boyar</a> (Path) and piecing together various chunks
of wisdom from <a href="https://twitter.com/jakewharton">Jake Wharton</a> (Square).</p>

<p>Let’s get to it!</p>

<hr />

<p>Rule number one: you should <em>never</em> be making network requests directly from an
Activity (I will just say Activity from here on out, but everything applies to
Fragments as well). Even using an <code class="highlighter-rouge">AsyncTask</code> is asking for trouble; when the
task finally completes, you have to guard against the fact that your host
activity could be gone (rotated, destroyed in the back stack, back pressed). Are
you leaking memory by holding Activity references? Are you sure?</p>

<p>So many example apps just shovel everything into Activities. It is not uncommon
for an Activity in a tutorial (or even official SDK samples) to have 500-800
lines of code. This is analogous to having a 500-800 line controller in your web
application! This is not good!</p>

<p>So where should I be making network requests then? My recommendation is in a
plain-old Java object (POJO) that is tied to your <em>Application</em> lifecycle, not
your Activities.</p>

<p>If we can come up with an approach that allows a POJO to a) easily make network
calls and handle the responses and b) communicate with our activities without
keeping direct references, then we are in business.</p>

<p><a href="http://square.github.io/retrofit/">Retrofit</a> (combined with <a href="https://code.google.com/p/google-gson/">Gson</a>) is a joy to use when it comes to
making network calls. For communication with Activities, we can use a library
that implements the data bus pattern (<a href="http://square.github.io/otto/">Otto</a> or <a href="https://github.com/greenrobot/EventBus">EventBus</a> are the
popular options).</p>

<p>At a high-level, our architecture will look something like this:</p>

<ul>
  <li>Our <code class="highlighter-rouge">Application</code> will create POJOs to manage API interaction; I call these
POJOs “Services” (in the <a href="http://c2.com/cgi/wiki?WhatIsSoa">Service Oriented Architecture</a> sense). Regrettably,
this name is overloaded and is already a concept in Android, so use a
different name if you find this too confusing (maybe “Repository” from
<a href="http://c2.com/cgi/wiki?DomainDrivenDesign">Domain-driven design</a> would be better)</li>
  <li>Activities and Services will register on the bus and use this to communicate</li>
  <li>When we wish to load data from the API, we will post an event to the bus which
will cause the Service to start the network request</li>
  <li>When a network request finishes, the Service will post the result back on the
bus for any listening Activity to handle</li>
</ul>

<p>The devil is in the details, so let’s look at some code for a simple news-reader
app.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StoryActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">Bus</span> <span class="n">mBus</span><span class="o">;</span>

  <span class="kd">private</span> <span class="n">StoryListAdapter</span> <span class="n">mAdapter</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">ListView</span> <span class="n">mListView</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">story_activity</span><span class="o">);</span>

    <span class="n">mListView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">story_list</span><span class="o">);</span>

    <span class="n">mAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StoryListAdapter</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">mListView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mAdapter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>

    <span class="n">getBus</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">getBus</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">LoadStoriesEvent</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Subscribe</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStoriesLoaded</span><span class="o">(</span><span class="n">StoriesLoadedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mAdapter</span><span class="o">.</span><span class="na">setStories</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getStories</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPause</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onPause</span><span class="o">();</span>

    <span class="n">getBus</span><span class="o">().</span><span class="na">unregister</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// Use some kind of injection, so that we can swap in a mock for tests.</span>
  <span class="c1">// Here we just use simple getter/setter injection for simplicity.</span>
  <span class="kd">private</span> <span class="n">Bus</span> <span class="nf">getBus</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mBus</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mBus</span> <span class="o">=</span> <span class="n">BusProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">mBus</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBus</span><span class="o">(</span><span class="n">Bus</span> <span class="n">bus</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mBus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Everything is pretty standard in <code class="highlighter-rouge">onCreate</code>. We setup the view elements and
wire up our list adapter.</p>

<p>We register/unregister from the <code class="highlighter-rouge">Bus</code> in <code class="highlighter-rouge">onResume</code>/<code class="highlighter-rouge">onPause</code> — basically
if our activity is in the foreground, we want to be listening for events. This
can (and should) be moved to a base class (along with the getter/setters for
<code class="highlighter-rouge">mBus</code>).</p>

<p>We kick off the process in <code class="highlighter-rouge">onResume</code> by posting a <code class="highlighter-rouge">LoadStoriesEvent</code> on the
bus. Our <code class="highlighter-rouge">StoryService</code> will be subscribed to this event and kick off the API
calls.</p>

<p>Our activity then subscribes (with Otto’s <code class="highlighter-rouge">@Subscribe</code> annotation) to a
corresponding <code class="highlighter-rouge">StoriesLoadedEvent</code> — which will be posted after the API
call is returned and contain a list of <code class="highlighter-rouge">Story</code> objects to display.</p>

<p>Notice how event-driven our activity is and how simple the methods are.
Testing becomes straight-forward: inject a mock bus and assert that we post the
correct event to the bus when resuming. Call <code class="highlighter-rouge">onStoriesLoaded()</code> directly with
test data and assert we display the correct items.</p>

<p>Here is what the <code class="highlighter-rouge">StoryService</code> looks like:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StoryService</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">StoryApi</span> <span class="n">mApi</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Bus</span> <span class="n">mBus</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">StoryService</span><span class="o">(</span><span class="n">StoryApi</span> <span class="n">api</span><span class="o">,</span> <span class="n">Bus</span> <span class="n">bus</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mApi</span> <span class="o">=</span> <span class="n">api</span><span class="o">;</span>
    <span class="n">mBus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Subscribe</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoadStories</span><span class="o">(</span><span class="n">LoadStoriesEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mApi</span><span class="o">.</span><span class="na">loadStories</span><span class="o">(</span><span class="k">new</span> <span class="n">Callback</span><span class="o">&lt;</span><span class="n">StoryResponse</span><span class="o">&gt;</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">success</span><span class="o">(</span><span class="n">StoryResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Response</span> <span class="n">rawResponse</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mBus</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">StoriesLoadedEvent</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">stories</span><span class="o">));</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failure</span><span class="o">(</span><span class="n">RetrofitError</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mBus</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">ApiErrorEvent</span><span class="o">(</span><span class="n">error</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Both dependencies (<code class="highlighter-rouge">StoryApi</code> and <code class="highlighter-rouge">Bus</code>) are injected via the constructor, so we
can easily pass in mocks for testing. We can make use of Mockito’s
ArgumentCaptor (see <a href="http://www.mdswanson.com/blog/2013/12/16/reliable-android-http-testing-with-retrofit-and-mockito.html">this post</a> for more details) to test the asynchronous
callbacks. In fact, this whole class can be tested with regular old jUnit, so
the tests run super fast.</p>

<p>Our service accepts events from the bus and posts back new events after making
the appropriate API calls. If an activity initiated an API call and then gets
destroyed or backgrounded, we will still post the resulting response event, but
no one will be there to listen.</p>

<p>For completeness, here is how we connect everything up using a custom
Application class:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ReaderApplication</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">StoryService</span> <span class="n">mStoryService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Bus</span> <span class="n">mBus</span> <span class="o">=</span> <span class="n">BusProvider</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>

    <span class="n">mStoryService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StoryService</span><span class="o">(</span><span class="n">buildApi</span><span class="o">(),</span> <span class="n">mBus</span><span class="o">);</span>
    <span class="n">bus</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">mStoryService</span><span class="o">);</span>

    <span class="n">bus</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> <span class="c1">//listen for "global" events</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="n">StoryApi</span> <span class="nf">buildApi</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RestAdapter</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">setServer</span><span class="o">(</span><span class="n">API_URL</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">build</span><span class="o">()</span>
                  <span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">StoryApi</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Subscribe</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApiError</span><span class="o">(</span><span class="n">ApiErrorEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">toast</span><span class="o">(</span><span class="s">"Something went wrong, please try again."</span><span class="o">);</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"ReaderApp"</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getErrorMessage</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>So back to our original goal, is this approach more durable?</p>

<p>Configuration changes (rotation, phone call, etc) will not crash the app. We
don’t have a bunch of defensive programming or null checks sprinkled every
where. We can even swap out the data source without making changes to our
activity. If we want to retrieve data from a database instead, we just need to
make sure to post the <code class="highlighter-rouge">StoriesLoadedEvent</code> event once we retrieve the data. We
even have a more testable and less coupled design in the process!</p>

<p>Bear in mind that this approach is not the complete solution. We are always
re-querying data whenever our activity is resumed — this is not ideal for
battery life or necessary for data “freshness”. We could address this with
proper use of <code class="highlighter-rouge">onSaveInstanceState()</code> or some state-keeping to determine if a
request is already in-flight.</p>

<p>We don’t have much resilience against network errors or loss of connection. The
next step for addressing these issues would probably be to introduce a queue/job
manager to handle retries and perserving user input.</p>

<p>We still aren’t fully satisfying the “gold standard” from the Google I/O talk.
We will probably want to introduce local storage using SQLite and use this for
querying the data (while updating the underlying database in the background).
This provides a better user experience because we can update the UI immediately.</p>

<p>There is a lot of work required to create a truly robust REST client on Android
(or any mobile platform for that matter). Moving your network operations out
of the activity lifecycle using the approach outlined above is a good first step
down this path.</p>

<hr />

<p>I’d love to hear your thoughts, criticisms, or suggestions; get in touch with me
on <a href="https://twitter.com/_swanson">Twitter</a>.</p>

</div>      

  
    <hr class="fin"/>
  
</article>


  <footer>
  <div id="bio">
    <div id="bio-image">
      <img src="/static/mugshot.jpg" alt="Matt Swanson">
    </div>
    
    <div id="bio-text">
      <p>Hi. I'm <b>Matt Swanson</b>.</p>
      <p>I do things and sometimes write about it here. I'm a Software Engineer from Indiana and I ship code at <a href="http://www.sep.com/">SEP</a>.</p>
      
      <div id="bio-social">
        <strike>Stalk</strike> Follow me:
<div id="social-links">
  <a title="swanson on Github" href="http://github.com/swanson/"><i class="fa fa-github-square"></i></a>
  <a title="swanson on Hacker News" href="http://news.ycombinator.com/user?id=swanson"><i class="fa fa-hacker-news"></i></a>
  <a title="_swanson on Twitter" href="http://twitter.com/_swanson"><i class="fa fa-twitter-square"></i></a>
  <a title="RSS feed" id="rss" href="/atom.xml"><i class="fa fa-rss-square"></i></a>
</div>
      </div>
    </div>
  </div>

  
  <aside>
    <h3>Further reading</h3>
    <ul class="posts">
      
        
        
          
            <li><a href="/blog/2014/06/02/android-form-models.html">Extracting Form Models in Android</a></li>
          
        
          
        
          
            <li><a href="/blog/2014/02/24/integration-testing-rest-apis-for-android.html">Integration Testing against REST APIs in Android</a></li>
          
        
      
    </ul>
  </aside>
  
</footer>

<div id="fine-print">
  <p>
    built with <a href="#">&hearts;</a>, <a href="http://jekyllrb.com/">Jekyll</a>, and <a href="https://github.com/swanson/swanson.github.com">GitHub Pages</a> &mdash; read the <a href="/legal">fine print</a>
  </p>
</div>

  </section>

  
</body>
</html>
