<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="VikwqTxe7ybu1qSM7LFgIQpvHLN0_j-iVzaLqF88vEw" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matt Swanson - Two Lines of Code: An Open Source Tale</title>
  <meta name="author" content="Matt Swanson" />
  <meta name="description" content="writing on software, book writeups and projects by a software engineer from Indianapolis" />
  
  <link rel="canonical" href="http://mdswanson.com/blog/2014/05/14/open-source-tale.html" />

  <link href="//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Matt Swanson's Blog" href="http://localhost:4000/atom.xml" />

  
    <link rel="stylesheet" href="/css/site.css">
  
</head>
<body>
  <section>
    <header class="navigation">
  <a href="/" class="logo" title="ÄLG, a solitary moose.">
    <img src="/static/moose.png" alt="Moose">
  </a>
  <nav>
    <ul>
      <li><a href="/">writing</a></li>
      <li><a href="/archive">archive</a></li>
      <li><a href="/about">about</a></li>
      <li class="no-bullet"><a href="/atom.xml">rss</a></li>
    </ul>
  </nav>
</header>

<article>
  <h1 class="title">
    Two Lines of Code: An Open Source Tale
  </h1>

  
  <p class="subtitle">
    
      <span>
        
          Series:
          
            
              <a href="/#practices">practices</a>
            
          
        
      </span>

      <span class="date">
        May 14, 2014
      </span>
    
  </p>

  <div id="post"><h3 id="january-7-2014---093545-am">January 7, 2014 - 09:35:45 AM</h3>

<p>It all started with a JavaScript error…</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">Uncaught</span> <span class="nx">SyntaxError</span><span class="err">:</span> <span class="nx">Unexpected</span> <span class="nx">token</span> <span class="nx">ILLEGAL</span>
</code></pre>
</div>

<p>I was trying to catch up on my RSS items, but nothing was rendering on the page.</p>

<p>I dumped some debugging info and opened an <a href="https://github.com/swanson/stringer/issues/295">issue on GitHub</a>. I found a
workaround, but it involved marking all my stories as read. No time to look into
this issue now.</p>

<hr />

<h3 id="february-24-2014---021758-pm">February 24, 2014 - 02:17:58 PM</h3>

<p>Several other users have reported experiencing the same bug. A potential fix
that involved removing unprintable characters (<code class="highlighter-rouge">.gsub(/[^[:print:]]/, '')</code>) was 
proposed but didn’t seem to completely address the issue.</p>

<h3 id="march-27-2014---100015-pm">March 27, 2014 - 10:00:15 PM</h3>

<p>A comment on the [still unresolved] bug triggered an email notification from
GitHub earlier this morning. I had some time to look into it after work.</p>

<p>I went back to my original bug report and tried to create a minimal test
case that would reproduce the bug. I opened up the Chrome Dev console and started
pasting in chunks of the large string I was trying to parse.</p>

<p>Using a primitive form of <a href="http://git-scm.com/docs/git-bisect"><code class="highlighter-rouge">git bisect</code></a>, I tried the first half of the 
string to see if the error happened again. Nope. I halved the remaining part of 
the string. I repeated until I had it narrowed down to a few characters.</p>

<p>The string in question was “QNk8n”. Nothing jumps out as being extraordinary
about that string.</p>

<p>I pasted it into an <code class="highlighter-rouge">irb</code> session and found the likely culprit:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="s2">"QNk8n</span><span class="se">\U</span><span class="s2">+FFE2</span><span class="se">\U</span><span class="s2">+FFA8"</span>
</code></pre>
</div>

<p>Some weird unicode characters were being tacked onto the end!</p>

<p>Googling for “unicode 2028 javascript” led me to a really excellent
blog post explaining that <a href="http://timelessrepo.com/json-isnt-a-javascript-subset">JSON is not a true subset of JavaScript</a>.</p>

<p>The long and short of it: <code class="highlighter-rouge">u+2028</code> and <code class="highlighter-rouge">u+2029</code> are valid JSON but not valid
JavaScript. My app was trying to parse the JSON representation of the RSS
articles into JavaScript (via backbone.js) to be rendered.</p>

<p>I wrote a <a href="https://github.com/swanson/stringer/commit/71199cc432fe03ce483e3f7b55cea683c09d6cfc#diff-3ac47732f4ef157a8877f2753398056cR90">failing test</a> and then <a href="https://github.com/swanson/stringer/commit/2ae53ed8d47f9d9bf25dd9c41c18f9935a390de1">fixed the bug</a> (confession: my
first bug fix passed the test but <a href="https://github.com/swanson/stringer/pull/314">created another</a>, whoops).</p>

<p>Pushed. Deployed. Did a little dance.</p>

<h3 id="march-30-2014---065619-pm">March 30, 2014 - 06:56:19 PM</h3>

<p>I wanted to get this fix upstream. In addition to wanting to give back, I didn’t
want to have to implement this “hack” in my own app.</p>

<p>Next up the chain was <code class="highlighter-rouge">feedjira</code> — the gem I was using to parse RSS feeds.
Ultimately, this code probably belonged in <code class="highlighter-rouge">loofah</code> — an HTML sanitization 
gem used by <code class="highlighter-rouge">feedjira</code>, but that library seemed to be dormant.</p>

<p>After a brief discussion with maintainer <a href="https://github.com/jonallured">Jon Allured</a>, we both agreed to 
try to get the fixes into <code class="highlighter-rouge">loofah</code>. If we couldn’t, we would patch it in <code class="highlighter-rouge">feedjira</code>.</p>

<h3 id="april-6-2014---060001-pm">April 6, 2014 - 06:00:01 PM</h3>

<p>Finally got around to <a href="https://github.com/flavorjones/loofah/issues/65">opening an issue</a> with <code class="highlighter-rouge">loofah</code>. I proposed that we add
code to deal with the <strong>Evil JSON Characters</strong> as part of <code class="highlighter-rouge">loofah</code>’s sanitization
process.</p>

<p>Project maintainer <a href="https://github.com/flavorjones">Mike Dalessio</a> said this fix would be well received 
and pointed me toward the relevant sections of the codebase.</p>

<h3 id="april-12-2014---060422-pm">April 12, 2014 - 06:04:22 PM</h3>

<p>Deep dive into the <code class="highlighter-rouge">loofah</code> codebase to add a new “scrubber”!</p>

<p>The <code class="highlighter-rouge">loofah</code> architecture was interesting; the scrubbers are basically parsers 
that operate on <code class="highlighter-rouge">nokogiri</code> nodes. You can make a top-down or a bottom-up parser 
and you can control when you break out of the tree as you walk the nodes.</p>

<p>With Mike’s initial direction guiding me, I got a working implementation and 
opened a <a href="https://github.com/flavorjones/loofah/pull/66">pull request</a>.</p>

<h3 id="april-21-2014---062036-pm">April 21, 2014 - 06:20:36 PM</h3>

<p>A friendly ping to Mike and my <a href="https://github.com/flavorjones/loofah/commit/273e30297d85d81ad170843f2523305816d9f25d">PR gets merged</a>.</p>

<h3 id="may-9-2014---064954-pm">May 9, 2014 - 06:49:54 PM</h3>

<p><code class="highlighter-rouge">loofah</code> version 2.0.0 is <a href="https://rubygems.org/gems/loofah/versions">released</a> (which includes my fix) and pushed to
RubyGems.</p>

<p>Now that the fix has been applied upstream, we now have to update gem versions
downstream.</p>

<h3 id="may-13-2014---041917-pm">May 13, 2014 - 04:19:17 PM</h3>

<p>I open a new <a href="https://github.com/feedjira/feedjira/pull/223">PR</a> in <code class="highlighter-rouge">feedjira</code> to update the <code class="highlighter-rouge">loofah</code> version.</p>

<p>The PR is <a href="https://github.com/feedjira/feedjira/commit/d382f8ac1ffed29e9215996d03981506da6602dd">merged</a> and <code class="highlighter-rouge">feedjira</code> version 1.3.0 is <a href="https://rubygems.org/gems/feedjira/versions/1.3.0">released</a>.</p>

<h3 id="may-14-2014---114435-am">May 14, 2014 - 11:44:35 AM</h3>

<p>I can bump the versions of <code class="highlighter-rouge">feedjira</code> and <code class="highlighter-rouge">loofah</code> used in Stringer and I
can finally <a href="https://github.com/swanson/stringer/commit/5102bb6b3a595a764de010c721c59736a6be3295">replace</a> the patch with <code class="highlighter-rouge">scrub!(:unprintable)</code>.</p>

<p>Victory!</p>

<hr />

<p>So five months later, my two line of code bug fix has made it all the way
upstream and then back again! It may not seem like much, but this is the magic 
of open source.</p>

<p>This bug originally affected a few users of Stringer, but by sending the 
patch upstream, thousands of people have benefited (<code class="highlighter-rouge">loofah</code> and <code class="highlighter-rouge">feedjira</code> 
have over 500k combined downloads).</p>

</div>      

  
    <hr class="fin"/>
  
</article>


  <footer>
  <div id="bio">
    <div id="bio-image">
      <img src="/static/mugshot.jpg" alt="Matt Swanson">
    </div>
    
    <div id="bio-text">
      <p>Hi. I'm <b>Matt Swanson</b>.</p>
      <p>I do things and sometimes write about it here. I'm a Software Engineer from Indiana and I ship code at <a href="http://www.sep.com/">SEP</a>.</p>
      
      <div id="bio-social">
        <strike>Stalk</strike> Follow me:
<div id="social-links">
  <a title="swanson on Github" href="http://github.com/swanson/"><i class="fa fa-github-square"></i></a>
  <a title="swanson on Hacker News" href="http://news.ycombinator.com/user?id=swanson"><i class="fa fa-hacker-news"></i></a>
  <a title="_swanson on Twitter" href="http://twitter.com/_swanson"><i class="fa fa-twitter-square"></i></a>
  <a title="RSS feed" id="rss" href="/atom.xml"><i class="fa fa-rss-square"></i></a>
</div>
      </div>
    </div>
  </div>

  
  <aside>
    <h3>Further reading</h3>
    <ul class="posts">
      
        
        
          
            <li><a href="/blog/2016/04/22/compounding-technical-debt.html">Compounding technical debt</a></li>
          
        
          
            <li><a href="/blog/2016/01/25/sell-or-kill.html">Internal tools should be sold or killed</a></li>
          
        
          
            <li><a href="/blog/2015/10/26/code-neutral.html">Code Neutral</a></li>
          
        
      
    </ul>
  </aside>
  
</footer>

<div id="fine-print">
  <p>
    built with <a href="#">&hearts;</a>, <a href="http://jekyllrb.com/">Jekyll</a>, and <a href="https://github.com/swanson/swanson.github.com">GitHub Pages</a> &mdash; read the <a href="/legal">fine print</a>
  </p>
</div>

  </section>

  
</body>
</html>
