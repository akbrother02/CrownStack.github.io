<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="VikwqTxe7ybu1qSM7LFgIQpvHLN0_j-iVzaLqF88vEw" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matt Swanson - Extracting Form Models in Android</title>
  <meta name="author" content="Matt Swanson" />
  <meta name="description" content="writing on software, book writeups and projects by a software engineer from Indianapolis" />
  
  <link rel="canonical" href="http://mdswanson.com/blog/2014/06/02/android-form-models.html" />

  <link href="//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Matt Swanson's Blog" href="http://localhost:4000/atom.xml" />

  
    <link rel="stylesheet" href="/css/site.css">
  
</head>
<body>
  <section>
    <header class="navigation">
  <a href="/" class="logo" title="ÄLG, a solitary moose.">
    <img src="/static/moose.png" alt="Moose">
  </a>
  <nav>
    <ul>
      <li><a href="/">writing</a></li>
      <li><a href="/archive">archive</a></li>
      <li><a href="/about">about</a></li>
      <li class="no-bullet"><a href="/atom.xml">rss</a></li>
    </ul>
  </nav>
</header>

<article>
  <h1 class="title">
    Extracting Form Models in Android
  </h1>

  
  <p class="subtitle">
    
      <span>
        
          Series:
          
            
              <a href="/#android">android</a>
            
          
        
      </span>

      <span class="date">
        June 02, 2014
      </span>
    
  </p>

  <div id="post"><p>In my continuing <a href="http://www.mdswanson.com/blog/2014/04/07/durable-android-rest-clients.html">quest to get code out of Android Activities</a>, I’ve implemented
the traditional “Form Model” pattern in a recent project with great success and wanted
to share my thoughts.</p>

<p>The basic idea is to extract the code for handling the UI interactions, as well
as the data binding and any state keeping, into its own class. This separation
feels natural and keeps our Activities simple.</p>

<p>I think this is an area that is not often explored in Android — there is
less of an emphasis on data entry and forms in most of the developer documentation.
When you think of a lot of the popular social apps, most of the screens are just
displaying information; they might have a few screens to compose a tweet or message,
but the pain is not high.</p>

<p>For me, my past two Android applications have been <em>very heavy</em> on data entry. I think
this is partial due to the domains (health care, finance) and the clients (closer to
Enterprise than Start-up). But we were constantly making complex messes of our “form
input” screens — especially when we started adding things like editing existing
items, prompting to discard unsaved changes, and handling rotation without clearing
all the fields.</p>

<p>Using this form model approach has led to fewer bugs, more understandable code, and 
happier developers.</p>

<h2 id="example-search-form">Example: Search form</h2>

<p>We have a banking app and we want to have a screen for searching through our 
transactions. There will be multiple filters: let’s just start with an account spinner,
a keyword field and an amount range. (Hopefully, you can see how more of these filters will
likely be added in the future and how the complexity could explode).</p>

<p>Instead of shoving all of the views, click handlers, validation logic, and data binding
into an Activity, we will create a <code class="highlighter-rouge">SearchForm</code> class to handle all of this.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SearchForm</span> <span class="kd">extends</span> <span class="n">LinearLayout</span> <span class="o">{</span>

  <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">account</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">Spinner</span> <span class="n">mAccountSpinner</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">AccountAdapter</span> <span class="n">mAccountAdapter</span><span class="o">;</span>

  <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">keyword</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">EditText</span> <span class="n">mKeywordField</span><span class="o">;</span>

  <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">min_amount</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">CurrencyEditText</span> <span class="n">mMinAmountField</span><span class="o">;</span>

  <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">max_amount</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">CurrencyEditText</span> <span class="n">mMaxAmountField</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="nf">SearchFormModel</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>
    <span class="n">setup</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">search_form</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="n">ButterKnife</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> <span class="c1">// &lt;3 @JakeWharton</span>

    <span class="n">mAccountAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountAdapter</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">mAccountSpinner</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mAccountAdapter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Account</span><span class="o">&gt;</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mAccountAdapter</span><span class="o">.</span><span class="na">setItems</span><span class="o">(</span><span class="n">accounts</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getKeywords</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mKeywordField</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKeywords</span><span class="o">(</span><span class="n">String</span> <span class="n">keywords</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mKeywordField</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">keywords</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">MoneyAmount</span> <span class="nf">getMinimumAmount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mMinAmountField</span><span class="o">.</span><span class="na">getAmount</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMinimumAmount</span><span class="o">(</span><span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mMinmountField</span><span class="o">.</span><span class="na">setAmountFromDouble</span><span class="o">(</span><span class="n">amount</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">MoneyAmount</span> <span class="nf">getMaximumAmount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mMaxAmountField</span><span class="o">.</span><span class="na">getAmount</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaximumAmount</span><span class="o">(</span><span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mMaxAmountField</span><span class="o">.</span><span class="na">setAmountFromDouble</span><span class="o">(</span><span class="n">amount</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Account</span> <span class="nf">getSelectedAccount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mAccountSpinner</span><span class="o">.</span><span class="na">getSelectedItem</span><span class="o">();</span>
  <span class="o">}</span>  

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">clearErrors</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">isValid</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">isValidAmountRange</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">isValid</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="n">mMinAmountField</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="s">"Invalid range"</span><span class="o">);</span>
      <span class="n">mMaxAmountField</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="s">"Invalid range"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">isValid</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isValidAmountRange</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getMinimumAmount</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">getMaximumAmount</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">clearErrors</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mMinAmountField</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="n">mMaxAmountField</span><span class="o">.</span><span class="na">setError</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">SearchParameters</span> <span class="nf">buildParameters</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">SearchParameters</span><span class="o">(</span><span class="n">getSelectedAccount</span><span class="o">(),</span>
                                <span class="n">getKeywords</span><span class="o">(),</span>
                                <span class="n">getMinimumAmount</span><span class="o">(),</span>
                                <span class="n">getMaximumAmount</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">persist</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">outState</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"SELECTED_ACCT_INDEX"</span><span class="o">,</span> <span class="n">mAccountSpinner</span><span class="o">.</span><span class="na">getSelectedItemPosition</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">restore</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">bundle</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">accountPosition</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"SELECTED_ACCT_INDEX"</span><span class="o">);</span>
    <span class="n">mAccountSpinner</span><span class="o">.</span><span class="na">setSelection</span><span class="o">(</span><span class="n">accountPosition</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>We create a class that derives from <code class="highlighter-rouge">LinearLayout</code> (or maybe a <code class="highlighter-rouge">FrameLayout</code> if you prefer)
which allows us to group up the related controls into one layout that we will inflate. We
setup our views and create an adapter for the list of accounts.</p>

<p>We wrap up the Android controls in getter/setters — this may be somewhat controversial,
but I think it makes for a better public API for <code class="highlighter-rouge">SearchForm</code>. We’ve got a method to validate
the user input and apply errors if needed. We have <code class="highlighter-rouge">buildParameters()</code> that does some data
binding and returns a domain object. And we finish it off with two methods that interact with
Android’s <code class="highlighter-rouge">onSaveInstanceState</code> Bundle to handle custom configuration changes (note that most
stock UI controls will handle their own persistence).</p>

<p>This is about a hundred lines of code and is pretty good for the most part. Everything in this
class seems like it belongs in a “search form” object and there are good extension points for
future features (date range filter, expense vs deposit filters, checks only, etc). We
intentionally avoid dealing with <strong>how</strong> we get some of the data, leaving that up to other,
more appropriate parts of the code.</p>

<p>What do things look like on the Activity side?</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionSearchActivity</span> <span class="kd">extends</span> <span class="n">BaseActivity</span> <span class="o">{</span>
  
  <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">search_form</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">SearchForm</span> <span class="n">mForm</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">transaction_search</span><span class="o">);</span>
    <span class="n">setTitle</span><span class="o">(</span><span class="s">"Search Your Transactions"</span><span class="o">);</span>

    <span class="n">mForm</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">mAccounts</span><span class="o">);</span> <span class="c1">// fetch accounts via API/DB/etc</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mForm</span><span class="o">.</span><span class="na">restore</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onOptionsItemSelected</span><span class="o">(</span><span class="n">MenuItem</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">menu</span><span class="o">.</span><span class="na">getItemId</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_submit_search</span><span class="o">:</span>
        <span class="n">onSubmitSearch</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onOptionsItemSelected</span><span class="o">(</span><span class="n">menu</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">onSubmitSearch</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mForm</span><span class="o">.</span><span class="na">validate</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">// Do your magic, post to an API/DB/etc</span>
      <span class="c1">// You have access to the domain object with mForm.buildParameters()</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreateOptionsMenu</span><span class="o">(</span><span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">getMenuInflater</span><span class="o">().</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">menu</span><span class="o">.</span><span class="na">search_menu</span><span class="o">,</span> <span class="n">menu</span><span class="o">);</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onCreateOptionsMenu</span><span class="o">(</span><span class="n">menu</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onSaveInstanceState</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>

    <span class="n">mForm</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">outState</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Our Activity will include a <code class="highlighter-rouge">&lt;com.example.SearchForm /&gt;</code> tag in it’s XML layout and
then just handle high-level user interactions (hitting submit in the ActionBar) and
coordinates fetching and storing data. The heavy UI lifting and form logic is delegated 
to the <code class="highlighter-rouge">SearchForm</code>.</p>

<p>This activity comes in at around 50 lines — most of which is just boilerplate from
the framework for lifecycles and menu creation.</p>

<h2 id="overall-impressions">Overall impressions</h2>

<p>Things get a bit more complex once you start talking to an API or database, but overall
by moving the form-specific logic and view concerns out of the Activity, the code becomes
easier to understand.</p>

<p>I can write a whole slew of Robolectric tests on <code class="highlighter-rouge">SearchForm</code> without
getting bogged down in the activity lifecycle. I can write tests about the interactions with
form, the ActionBar, and the backend without exercising every edgecase. And when it comes 
time to add a new filter to the form, I will likely avoid having to make any changes to 
the Activity (ala the <a href="http://en.wikipedia.org/wiki/Open/closed_principle">Open/closed principle</a> for those playing Design Pattern Bingo 
at home).</p>

<p>Coming from other frameworks (and speaking with other developers), data binding is
pretty lacking on Android. Something still seems a bit off with this design because we
are coupled tightly to Android classes and there is dependency on knowing the order of
methods to call (e.g. <code class="highlighter-rouge">initialize()</code> should be called before <code class="highlighter-rouge">validate()</code>) — however
I think it is an improvement over the “giant mud ball Activity”.</p>

<p>As your form models get more and more complex, you may want to think about extracting
validations to a separate object and moving custom view functionality into their own
controls (as you can see in our example with the <code class="highlighter-rouge">CurrencyEditText</code>). Also, consider
that complex forms might better serve the user being broken up into multiple steps as
a wizard.</p>

<p>We’ve found this pattern to be a big win in untangling hairy form code and I would
recommend giving it a try. I’ve formalized the code patterns a bit more and created a
small base class to reduce a bit of boilerplate going forward, feel free to <a href="https://gist.github.com/swanson/c6c88710ff63d88de004">borrow it</a>.</p>

<hr />

<p>I’d love to hear your thoughts, criticisms, or suggestions; get in touch with me
on <a href="https://twitter.com/_swanson">Twitter</a>.</p>

</div>      

  
    <hr class="fin"/>
  
</article>


  <footer>
  <div id="bio">
    <div id="bio-image">
      <img src="/static/mugshot.jpg" alt="Matt Swanson">
    </div>
    
    <div id="bio-text">
      <p>Hi. I'm <b>Matt Swanson</b>.</p>
      <p>I do things and sometimes write about it here. I'm a Software Engineer from Indiana and I ship code at <a href="http://www.sep.com/">SEP</a>.</p>
      
      <div id="bio-social">
        <strike>Stalk</strike> Follow me:
<div id="social-links">
  <a title="swanson on Github" href="http://github.com/swanson/"><i class="fa fa-github-square"></i></a>
  <a title="swanson on Hacker News" href="http://news.ycombinator.com/user?id=swanson"><i class="fa fa-hacker-news"></i></a>
  <a title="_swanson on Twitter" href="http://twitter.com/_swanson"><i class="fa fa-twitter-square"></i></a>
  <a title="RSS feed" id="rss" href="/atom.xml"><i class="fa fa-rss-square"></i></a>
</div>
      </div>
    </div>
  </div>

  
  <aside>
    <h3>Further reading</h3>
    <ul class="posts">
      
        
        
          
        
          
            <li><a href="/blog/2014/04/07/durable-android-rest-clients.html">Durable Android REST Clients</a></li>
          
        
          
            <li><a href="/blog/2014/02/24/integration-testing-rest-apis-for-android.html">Integration Testing against REST APIs in Android</a></li>
          
        
      
    </ul>
  </aside>
  
</footer>

<div id="fine-print">
  <p>
    built with <a href="#">&hearts;</a>, <a href="http://jekyllrb.com/">Jekyll</a>, and <a href="https://github.com/swanson/swanson.github.com">GitHub Pages</a> &mdash; read the <a href="/legal">fine print</a>
  </p>
</div>

  </section>

  
</body>
</html>
