<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="VikwqTxe7ybu1qSM7LFgIQpvHLN0_j-iVzaLqF88vEw" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matt Swanson - Update on Lanyon + Cross-domain AJAX POSTs with CORS</title>
  <meta name="author" content="Matt Swanson" />
  <meta name="description" content="writing on software, book writeups and projects by a software engineer from Indianapolis" />
  
  <link rel="canonical" href="http://mdswanson.com/blog/2011/08/21/update-on-lanyon-crossdomain-ajax-posts.html" />

  <link href="//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Matt Swanson's Blog" href="http://localhost:4000/atom.xml" />

  
    <link rel="stylesheet" href="/css/site.css">
  
</head>
<body>
  <section>
    <header class="navigation">
  <a href="/" class="logo" title="ÄLG, a solitary moose.">
    <img src="/static/moose.png" alt="Moose">
  </a>
  <nav>
    <ul>
      <li><a href="/">writing</a></li>
      <li><a href="/archive">archive</a></li>
      <li><a href="/about">about</a></li>
      <li class="no-bullet"><a href="/atom.xml">rss</a></li>
    </ul>
  </nav>
</header>

<article>
  <h1 class="title">
    Update on Lanyon + Cross-domain AJAX POSTs with CORS
  </h1>

  
  <p class="subtitle">
    
      <span>
        
          Series:
          
            
              <a href="/#worklog">worklog</a>
            
          
        
      </span>

      <span class="date">
        August 21, 2011
      </span>
    
  </p>

  <div id="post"><p>An update is long past due on <a href="https://github.com/swanson/lanyon">Lanyon</a> (my Jeykll WYSIWYG editor project) so here
is a recap since the last post.</p>

<p>As of my <a href="/blog/2011/07/23/digging-around-the-github-api-take-2.html">last update</a>, I had figured out how to make a commit with the Github API. Everything
was working with <code class="highlighter-rouge">curl</code>, but when I hooked up the code to call the API from the browser I ran
into issues regarding <a href="http://en.wikipedia.org/wiki/Same_origin_policy">same-origin policy</a> when doing cross-domain AJAX requests.</p>

<p>For GET requests, there were no issues since I can use <a href="http://en.wikipedia.org/wiki/JSONP">JSONP</a>. By including a callback function in 
my JavaScript code, the server will respond with my function with inlined arguments populated 
by the requested data. This function is then injected into the DOM and wrapped in a <code class="highlighter-rouge">&lt;script&gt;</code> tag.</p>

<p>To trigger this behavior, I just needed to set the <code class="highlighter-rouge">dataType</code> option of the jQuery <code class="highlighter-rouge">$.ajax()</code> 
call to be <code class="highlighter-rouge">jsonp</code> and set the <code class="highlighter-rouge">jsonpCallback</code> option to my callback function.</p>

<p>For POST requests, it’s a whole different game. If you try to just do the POST normally,
you will find yourself with a “same origin policy” error. Searching the web will reveal a ton
of information about different work-arounds - the most popular being to use an <code class="highlighter-rouge">&lt;iframe&gt;</code>, use
some other plugin like <a href="http://easyxdm.net/"><code class="highlighter-rouge">easyXDM</code></a>, or write your own server proxy.</p>

<p>The <code class="highlighter-rouge">&lt;iframe&gt;</code> approach relies on setting the frame’s domain to be the same as your target
and then submitting an injected form to the desired URL. I started going down this path but I
found that you couldn’t get the response from the POST, which was critical in my case.</p>

<p>The <code class="highlighter-rouge">easyXDM</code> route involves communicating between your main window and an <code class="highlighter-rouge">&lt;iframe&gt;</code> using
the <code class="highlighter-rouge">postMessage</code> API supported in some browsers. I didn’t really grok how it was supposed to
work, but I believe it would require changes to both my domain and my target domain. And since 
I can’t control Github’s domain, I don’t think it would fit my needs.</p>

<p>The last route, a server proxy, seemed to be most feasible. I could throw together a little Sinatra
app that proxied my requests over to api.github.com and since I would control the server, I could perform
all of the requests at once and have control over the cross-domain policies.</p>

<p>The problem with this approach was that it would need maintenance and extra resources. The whole point of 
the project was to make the requests on the client side so that anyone could drop the script into their 
blog. Now I would have to keep the server up and running and now people have to trust that I’m not storing 
their credentials on my server (I wouldn’t trust someone else with them).</p>

<p>After doing more research, I found that, at one point, the Github API supported <a href="http://en.wikipedia.org/wiki/Cross-Origin_Resource_Sharing">CORS</a>, which is a 
spec that allows for exemptions to the same-origin policy. I sent a message to <a href="https://github.com/technoweenie">Rick at Github</a>
and, to my surprise, he worked with me to re-enable CORS support! One restriction is that your origin needs to be 
registered as an OAuth app, but that was a non-issue.</p>

<p>I had some trouble with jQuery when making the request, but I finally got the right combination of settings
and it started working.  Here is some sample code for making the POST:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$.ajax({
    type: 'POST',
    url: 'API URL goes here',
    data: JSON.stringify(data),
    dataType: 'json',
    contentType: 'application/x-www-form-urlencoded',
    success: callback,
    beforeSend : function(xhr) {
	    xhr.setRequestHeader("Authorization", 
            "Basic " + that.base64encode(user + ':' + pw));
    }
});
</code></pre>
</div>

<p>For whatever reason, using the <code class="highlighter-rouge">username</code> and <code class="highlighter-rouge">password</code> options weren’t working and my authorization
headers weren’t being sent so I had to manually set the header and base64 encode my credentials.</p>

<p>I still need to do a bit more work related to setting the <a href="https://github.com/mojombo/jekyll/wiki/yaml-front-matter">YAML front matter</a> for the Jekyll posts
and to make some of my calls more generic (everything is hard coded to do the <code class="highlighter-rouge">git</code> operations in a 
test repo of mine). But I was able to write a post and get it committed and pushed to a repository
from the browser.</p>

<p>And then onward to editing posts and making the UI look pretty!</p>

</div>      

  
    <hr class="fin"/>
  
</article>


  <footer>
  <div id="bio">
    <div id="bio-image">
      <img src="/static/mugshot.jpg" alt="Matt Swanson">
    </div>
    
    <div id="bio-text">
      <p>Hi. I'm <b>Matt Swanson</b>.</p>
      <p>I do things and sometimes write about it here. I'm a Software Engineer from Indiana and I ship code at <a href="http://www.sep.com/">SEP</a>.</p>
      
      <div id="bio-social">
        <strike>Stalk</strike> Follow me:
<div id="social-links">
  <a title="swanson on Github" href="http://github.com/swanson/"><i class="fa fa-github-square"></i></a>
  <a title="swanson on Hacker News" href="http://news.ycombinator.com/user?id=swanson"><i class="fa fa-hacker-news"></i></a>
  <a title="_swanson on Twitter" href="http://twitter.com/_swanson"><i class="fa fa-twitter-square"></i></a>
  <a title="RSS feed" id="rss" href="/atom.xml"><i class="fa fa-rss-square"></i></a>
</div>
      </div>
    </div>
  </div>

  
  <aside>
    <h3>Further reading</h3>
    <ul class="posts">
      
        
        
          
            <li><a href="/blog/2013/08/07/interview-to-implementation-horizon-report.html">Interview to Implementation: Horizon Report</a></li>
          
        
          
            <li><a href="/blog/2013/07/24/step-by-step-ux-improvement-screenshot-upload.html">Step-by-Step UX Improvement: Screenshot Upload</a></li>
          
        
          
        
      
    </ul>
  </aside>
  
</footer>

<div id="fine-print">
  <p>
    built with <a href="#">&hearts;</a>, <a href="http://jekyllrb.com/">Jekyll</a>, and <a href="https://github.com/swanson/swanson.github.com">GitHub Pages</a> &mdash; read the <a href="/legal">fine print</a>
  </p>
</div>

  </section>

  
</body>
</html>
