<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="VikwqTxe7ybu1qSM7LFgIQpvHLN0_j-iVzaLqF88vEw" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matt Swanson - Half-Baked Thoughts on Ruby Web Architecture</title>
  <meta name="author" content="Matt Swanson" />
  <meta name="description" content="writing on software, book writeups and projects by a software engineer from Indianapolis" />
  
  <link rel="canonical" href="http://mdswanson.com/blog/2013/07/21/half-baked-thoughts-on-ruby-web-architecture.html" />

  <link href="//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Matt Swanson's Blog" href="http://localhost:4000/atom.xml" />

  
    <link rel="stylesheet" href="/css/site.css">
  
</head>
<body>
  <section>
    <header class="navigation">
  <a href="/" class="logo" title="ÄLG, a solitary moose.">
    <img src="/static/moose.png" alt="Moose">
  </a>
  <nav>
    <ul>
      <li><a href="/">writing</a></li>
      <li><a href="/archive">archive</a></li>
      <li><a href="/about">about</a></li>
      <li class="no-bullet"><a href="/atom.xml">rss</a></li>
    </ul>
  </nav>
</header>

<article>
  <h1 class="title">
    Half-Baked Thoughts on Ruby Web Architecture
  </h1>

  
  <p class="subtitle">
    
      <span>July 21, 2013</span>
    
  </p>

  <div id="post"><p>Some half-baked ideas I’ve been playing around with on my Ruby projects recently.</p>

<h1 id="informal-dci">Informal DCI</h1>

<p>I got really into DCI a few months ago. I picked up <a href="http://www.clean-ruby.com/">Clean Ruby</a> and acquired a copy of 
<a href="http://www.leansoftwarearchitecture.com/">Lean Architecture</a> (didn’t make it past page 10), but I need to explore most ideas in actual
code instead of books.</p>

<p>The idea of DCI — as I have cystallized it — is to extract behavior into groups
of roles or actions and then inject this new behavior into objects.</p>

<p>The canonical example, instead of this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:name</span>

  <span class="p">.</span><span class="nf">.</span><span class="p">.</span> <span class="nf">bunch</span> <span class="n">of</span> <span class="n">validators</span> <span class="p">.</span><span class="nf">.</span><span class="p">.</span>

  <span class="nf">.</span><span class="p">.</span><span class="nf">.</span> <span class="n">tons</span> <span class="n">of</span> <span class="n">other</span> <span class="n">crap</span> <span class="p">.</span><span class="nf">.</span><span class="p">.</span>

  <span class="nf">def</span> <span class="n">approve</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">state</span> <span class="o">=</span> <span class="ss">:approved</span>
    <span class="no">ApprovalMailer</span><span class="p">.</span><span class="nf">send_approval_mail</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre>
</div>

<p>Do something like this:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span> <span class="nf">only</span> <span class="n">user</span> <span class="n">model</span> <span class="n">stuff</span> <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>

<span class="k">class</span> <span class="nc">Approver</span>
  <span class="k">def</span> <span class="nf">approve</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">request</span><span class="p">.</span><span class="nf">state</span> <span class="o">=</span> <span class="ss">:approved</span>
    <span class="no">ApprovalMailer</span><span class="p">.</span><span class="nf">send_approval_mail</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">Approver</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">approve</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre>
</div>

<p>It is now easier to test the <code class="highlighter-rouge">Approver</code> behavior in isolation, <code class="highlighter-rouge">User</code> becomes less of a junk
drawer, it sort of makes more sense from a real-world sense since a user will be acting as 
an approver in some contexts (and maybe acting as a <code class="highlighter-rouge">Moderator</code> or something in another context).</p>

<p>I’ve seen some people <a href="http://mikepackdev.com/blog_posts/24-the-right-way-to-code-dci-in-ruby">arguing for a convention</a> were all of the behavior roles have a method
called <code class="highlighter-rouge">call</code>. This seems really silly to me and I can’t think of a good reason for it (and
the reason against it is that it hurts readability). I’ve also read arguments that using <code class="highlighter-rouge">extend</code>
really screws up the “method cache” and is <a href="http://tonyarcieri.com/dci-in-ruby-is-completely-broken">apparently bad</a>.</p>

<p>So for a while I was in this weird state: I liked the idea of DCI but none of the implementations
felt right. And if it didn’t feel right, I knew I wasn’t going to stick with it.</p>

<p>I tried to take some of the ideas about roles and behavior extraction in a slightly different way.
I looked at some of the Command/Query stuff that seems to be more popular in .NET-land and tried
building an app using Commands (or Use Cases, there is so much overloaded terminology it is
maddening).</p>

<p>This style felt right to me. I was writing a bunch of small, super focused classes to do some work.
My controllers were pretty simple and I stopped testing them for the most part.</p>

<p>Some examples from my <a href="https://github.com/swanson/stringer">RSS reader</a> (small Sinatra app):</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MarkAsRead</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">story_id</span><span class="p">,</span> <span class="n">repository</span> <span class="o">=</span> <span class="no">StoryRepository</span><span class="p">)</span>
    <span class="vi">@story_id</span> <span class="o">=</span> <span class="n">story_id</span>
    <span class="vi">@repo</span> <span class="o">=</span> <span class="n">repository</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">mark_as_read</span>
    <span class="vi">@repo</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="vi">@story_id</span><span class="p">).</span><span class="nf">update_attributes</span><span class="p">(</span><span class="ss">is_read: </span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s2">"/stories/mark_all_as_read"</span> <span class="k">do</span>
  <span class="no">MarkAllAsRead</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:story_ids</span><span class="p">]).</span><span class="nf">mark_as_read</span>
  
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s2">"/news"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImportFromOpml</span>
  <span class="nc">ONE_DAY</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">import</span><span class="p">(</span><span class="n">opml_contents</span><span class="p">)</span>
    <span class="n">feeds</span> <span class="o">=</span> <span class="no">OpmlParser</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">parse_feeds</span><span class="p">(</span><span class="n">opml_contents</span><span class="p">)</span>

    <span class="n">feeds</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">feed</span><span class="o">|</span>
      <span class="no">Feed</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="n">feed</span><span class="p">[</span><span class="ss">:name</span><span class="p">],</span>
                  <span class="ss">url: </span><span class="n">feed</span><span class="p">[</span><span class="ss">:url</span><span class="p">],</span>
                  <span class="ss">last_fetched: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="no">ONE_DAY</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s2">"/feeds/import"</span> <span class="k">do</span>
  <span class="no">ImportFromOpml</span><span class="p">.</span><span class="nf">import</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">"opml_file"</span><span class="p">][</span><span class="ss">:tempfile</span><span class="p">].</span><span class="nf">read</span><span class="p">)</span>

  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s2">"/setup/tutorial"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I combined these command/use-case things with Repositories and wrote most of the
test as isolated unit tests — super fast to run because I mock out the database…well,
and I’m not using Rails so they are pretty fast already.</p>

<h1 id="persistence-layer-separation">Persistence Layer Separation</h1>

<p>Repositories seem like a natural fit given the recent change of heart about Fat Models from
the Rails community. Again, my experience with this pattern comes from .NET, but the basic idea
is use a class to get a group of domain objects out of a database. I think about a Repository
as a group of Query objects with a common theme (usually the underlying model).</p>

<p>The code looks like:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StoryRepository</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="no">Story</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">is_read: </span><span class="kp">true</span><span class="p">).</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"published desc"</span><span class="p">).</span><span class="nf">page</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">per_page</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Instead of using a <code class="highlighter-rouge">scope</code> or putting more methods on <code class="highlighter-rouge">Story</code>, we just do the querying behind
a clean <code class="highlighter-rouge">StoryRepository#read</code> interface. This is definitely not common in the Rails apps I’ve
seen. I really like using this pattern: my controller isn’t cluttered with sort order or pagination
stuff, my model doesn’t need to know every possible way a caller wants to query it, I can
stub out that nasty method chain in a test easily.</p>

<p>This feels kind of strange for <code class="highlighter-rouge">ActiveRecord</code> based applications — since the domain objects
and the data mapping are the same thing, <code class="highlighter-rouge">ActiveRecord::Base</code> subclasses. In my experience
with other tools like <code class="highlighter-rouge">NHibernate</code> you have dumber domain objects and explicit mapping objects
that link up database columns to properties.</p>

<p>This separation comes with trade-offs: the Rails Way is quicker to code up (with just one class)
but you end up with hard coupling to the database whenever you create domain objects (not good
for tests). Maybe the <a href="https://github.com/rom-rb">Ruby Object Mapper</a> project will bring more popularity to splitting out
domain models and mapping objects.</p>

<p>I haven’t really found a good solution for this yet. My latest exploration was just stubbing the
Repository methods to return <code class="highlighter-rouge">OpenStruct</code>-like objects built in test factories.</p>

<h1 id="dependency-injection">Dependency Injection</h1>

<p>DI is so easy in Ruby and really helps with testing. I don’t think I would ever go without it
anymore. I also like how glaringly obvious your dependencies become when you use injection.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FeedDiscovery</span>
  <span class="k">def</span> <span class="nf">discover</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">finder</span> <span class="o">=</span> <span class="no">Feedbag</span><span class="p">,</span> <span class="n">parser</span> <span class="o">=</span> <span class="no">Feedzirra</span><span class="o">::</span><span class="no">Feed</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I could lie and say that this pattern is handy if I ever need to swap out gems, but who am I 
kidding? That never actually happens. Since Ruby allows for default arguments there is really 
no downside to this style of coding — the calling interface is the same but I can test much 
easier. Win, win.</p>

<h1 id="controller-callbacks">Controller Callbacks</h1>

<p>The biggest problem I had with my use-case/command style was that handling more than the happy
path flow in the controller got clunky. I see two possible solutions to look into: returning
result objects or some kind of callbacks on the controller.</p>

<p>Result objects seem like the more tame path. Define some convention for status, probably a hash
with keys like <code class="highlighter-rouge">:status</code>, <code class="highlighter-rouge">:errors</code>, and <code class="highlighter-rouge">:model</code> and then handle that in the controller.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">result</span> <span class="o">=</span> <span class="no">AddFeedSubscription</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:feed</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="ss">:status</span><span class="p">]</span> <span class="o">==</span> <span class="ss">:success</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Subscribed!"</span>
    <span class="n">redirect_to</span> <span class="n">result</span><span class="p">[</span><span class="ss">:model</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:errors</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="ss">:errors</span><span class="p">]</span>
    <span class="n">render</span> <span class="s2">"new"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I don’t think this is a bad approach and probably what I would do with a team larger than 2.</p>

<p>The other approach, which I first saw in Hexagonal Rails, is to pass the controller as an 
argument and call methods on it.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">result</span> <span class="o">=</span> <span class="no">AddFeedSubscription</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:feed</span><span class="p">]).</span><span class="nf">subscribe</span>
<span class="k">end</span>

<span class="kp">private</span>
  <span class="k">def</span> <span class="nf">subscription_succeeded</span><span class="p">(</span><span class="n">subscription</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Subscribed!"</span>
    <span class="n">redirect_to</span> <span class="n">subscription</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">subscription_failed</span><span class="p">(</span><span class="n">subscription</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:errors</span><span class="p">]</span> <span class="o">=</span> <span class="n">subscription</span><span class="p">.</span><span class="nf">errors</span>
    <span class="n">render</span> <span class="s2">"new"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AddFeedSubscription</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="vi">@callback</span> <span class="o">=</span> <span class="n">callback</span>
    <span class="vi">@params</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">subscribe</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span> <span class="nf">some</span> <span class="n">work</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span>

    <span class="vi">@callback</span><span class="p">.</span><span class="nf">subscription_succeeded</span><span class="p">(</span><span class="n">subscription</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This seems kind of inside-out, but something feels right about it to me. If you are going to have
more than a if/else branch in the controller action, then the callbacks seem like they might be a
win.</p>

<p>And controller testing can mostly go out the window. Throw in a double for callback and keep the
actual callbacks simple and mostly framework plumbing and I think you have a recipe for good design.</p>

<p>This idea seems to be the one advocated by the <a href="http://dci-in-ruby.info/technical_overview.html">DCI in Ruby sample application</a>, which
is the closest resource I’ve found that mirrors my own preferences and findings.</p>

<h1 id="whats-still-stewing">What’s still stewing?</h1>

<p>Decorators/Presenters/View Models - I think if you are going all-in on view models then you should
use something logicless, but that means Liquid right now for your templating. I can’t imagine
building a whole app using Liquid and not wanting to pull my hair out.</p>

<p>Client-side JS - Can this co-exist with a typically server side app? Or are you in for a world of
hurt if you don’t put clients-ide MVC as the first class citizen and just build a JSON API backend?
My limited experience trying to use Backbone with Sinatra was painful, but workable.</p>

</div>      

  
    <hr class="fin"/>
  
</article>


  <footer>
  <div id="bio">
    <div id="bio-image">
      <img src="/static/mugshot.jpg" alt="Matt Swanson">
    </div>
    
    <div id="bio-text">
      <p>Hi. I'm <b>Matt Swanson</b>.</p>
      <p>I do things and sometimes write about it here. I'm a Software Engineer from Indiana and I ship code at <a href="http://www.sep.com/">SEP</a>.</p>
      
      <div id="bio-social">
        <strike>Stalk</strike> Follow me:
<div id="social-links">
  <a title="swanson on Github" href="http://github.com/swanson/"><i class="fa fa-github-square"></i></a>
  <a title="swanson on Hacker News" href="http://news.ycombinator.com/user?id=swanson"><i class="fa fa-hacker-news"></i></a>
  <a title="_swanson on Twitter" href="http://twitter.com/_swanson"><i class="fa fa-twitter-square"></i></a>
  <a title="RSS feed" id="rss" href="/atom.xml"><i class="fa fa-rss-square"></i></a>
</div>
      </div>
    </div>
  </div>

  
  <aside>
    <h3>Further reading</h3>
    <ul class="posts">
      
        
        
      
    </ul>
  </aside>
  
</footer>

<div id="fine-print">
  <p>
    built with <a href="#">&hearts;</a>, <a href="http://jekyllrb.com/">Jekyll</a>, and <a href="https://github.com/swanson/swanson.github.com">GitHub Pages</a> &mdash; read the <a href="/legal">fine print</a>
  </p>
</div>

  </section>

  
</body>
</html>
