<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="VikwqTxe7ybu1qSM7LFgIQpvHLN0_j-iVzaLqF88vEw" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matt Swanson - Reliable API testing for Android with Retrofit and Mockito</title>
  <meta name="author" content="Matt Swanson" />
  <meta name="description" content="writing on software, book writeups and projects by a software engineer from Indianapolis" />
  
  <link rel="canonical" href="http://mdswanson.com/blog/2013/12/16/reliable-android-http-testing-with-retrofit-and-mockito.html" />

  <link href="//fonts.googleapis.com/css?family=Nunito:400,700,300|Varela+Round" rel="stylesheet" type="text/css">

  <link rel="shortcut icon" href="/static/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Matt Swanson's Blog" href="http://localhost:4000/atom.xml" />

  
    <link rel="stylesheet" href="/css/site.css">
  
</head>
<body>
  <section>
    <header class="navigation">
  <a href="/" class="logo" title="ÄLG, a solitary moose.">
    <img src="/static/moose.png" alt="Moose">
  </a>
  <nav>
    <ul>
      <li><a href="/">writing</a></li>
      <li><a href="/archive">archive</a></li>
      <li><a href="/about">about</a></li>
      <li class="no-bullet"><a href="/atom.xml">rss</a></li>
    </ul>
  </nav>
</header>

<article>
  <h1 class="title">
    Reliable API testing for Android with Retrofit and Mockito
  </h1>

  
  <p class="subtitle">
    
      <span>
        
          Series:
          
            
              <a href="/#android">android</a>
            
          
        
      </span>

      <span class="date">
        December 16, 2013
      </span>
    
  </p>

  <div id="post"><p>Testing HTTP calls that interact with an API have always been a tricky beast.
Hitting a real web server comes with a host of issues: brittle tests (test
fail because your internet or the API is down), slow tests (HTTP calls can
take several seconds each), and incomplete tests (“How do I trigger a rate
limit exceeded case? Guess I’ll just hope it works…”).</p>

<p>The issue is complicated further in a platform like Android, where HTTP calls
should be asynchronous. Now you add timing into the mix and you are probably
ready to throw in the towel on testing your API calls.</p>

<p>A great way to solve these issues and reliably exercise these HTTP calls is
to use a nifty utility in <a href="https://code.google.com/p/mockito/">Mockito</a> (a test double library for Java): 
<a href="http://docs.mockito.googlecode.com/hg/org/mockito/ArgumentCaptor.html"><code class="highlighter-rouge">ArgumentCaptor</code></a>.</p>

<p>The <code class="highlighter-rouge">ArgumentCaptor</code> is kind of a hybrid test double; it is a little like a stub,
a little like a spy, but not quite either one. You use an argument captor to —
unsurprisingly — capture and store the arguments passed to a mock/stub.
The real win here is the ability to call methods on the captured argument, which
works great for something like <a href="http://square.github.io/retrofit/">Retrofit’s callbacks</a>.</p>

<p>With Retrofit, we make an API call and provide a callback. The library will
run the callback, passing in the response data when the server responds.</p>

<p>Let’s say we have some code to query the <a href="http://developer.github.com/v3/repos/#list-user-repositories">GitHub API</a> for a user’s repositories.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">getApi</span><span class="o">().</span><span class="na">repositories</span><span class="o">(</span><span class="s">"swanson"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Callback</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">success</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;</span> <span class="n">repositories</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">repositories</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">displaySadMessage</span><span class="o">();</span>
        <span class="o">}</span>
            
        <span class="n">mAdapter</span><span class="o">.</span><span class="na">setRepositories</span><span class="o">(</span><span class="n">repositories</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failure</span><span class="o">(</span><span class="n">RetrofitError</span> <span class="n">retrofitError</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">displayErrorMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre>
</div>

<p>There are three cases we want to test: the happy path (we got some repos and
pass them to our adapter), the error path (there was some server error, toast
a message to the user), and a special case (the user has no repos, toast a 
message to the user).</p>

<p>The second and third cases will be tricky to test if you are relying on hitting
a real API server. I know GitHub has had some DDOS issues lately, but you certainly
can’t rely on that to test your error cases!</p>

<p>But with an <code class="highlighter-rouge">ArgumentCaptor</code>, we can grab the callback argument and then we have
full control of what data we send in.</p>

<p>Let’s look at testing the happy path (I am using <a href="http://robolectric.org/">Robolectric</a> and you should
be too!).</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">mockApi</span><span class="o">).</span><span class="na">repositories</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">cb</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
        
<span class="n">List</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;</span> <span class="n">testRepos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;();</span>
<span class="n">testRepos</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Repository</span><span class="o">(</span><span class="s">"rails"</span><span class="o">,</span> <span class="s">"ruby"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Owner</span><span class="o">(</span><span class="s">"dhh"</span><span class="o">)));</span>
<span class="n">testRepos</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Repository</span><span class="o">(</span><span class="s">"android"</span><span class="o">,</span> <span class="s">"java"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Owner</span><span class="o">(</span><span class="s">"google"</span><span class="o">)));</span>

<span class="n">cb</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">success</span><span class="o">(</span><span class="n">testRepos</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getListAdapter</span><span class="o">()).</span><span class="na">hasCount</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</code></pre>
</div>

<p>Our captor (<code class="highlighter-rouge">cb</code>) captures the callback and then, after calling <code class="highlighter-rouge">getValue()</code>, we
can call the <code class="highlighter-rouge">success</code> method and pass it some dummy objects.</p>

<p>You might have an “Aha!” moment now, but if not, that’s okay. Let’s look at
testing the error path.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">mockApi</span><span class="o">).</span><span class="na">repositories</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">cb</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
            
<span class="n">cb</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">failure</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">ShadowToast</span><span class="o">.</span><span class="na">getTextOfLatestToast</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="s">"Failed"</span><span class="o">);</span>
</code></pre>
</div>

<p>Same as before — we capture the callback. But this time we call the 
<code class="highlighter-rouge">failure</code> method, which simulates an API error. If we need more discrete error
handling (e.g. if the response is HTTP 401, redirect to login; if HTTP 500, 
toast a general system error message), we can easily create the appropriate
<code class="highlighter-rouge">RetrofitError</code> objects and pass them in.</p>

<p>The power of <code class="highlighter-rouge">ArgumentCaptor</code> really shines through here. We have complete
control of the object we’ve captured. We can feed it any data or trigger any 
error conditions we want.</p>

<p>For prosperity, let’s test the special case.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">mockApi</span><span class="o">).</span><span class="na">repositories</span><span class="o">(</span><span class="n">Mockito</span><span class="o">.</span><span class="na">anyString</span><span class="o">(),</span> <span class="n">cb</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>
            
<span class="n">List</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;</span> <span class="n">noRepos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;();</span>

<span class="n">cb</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">success</span><span class="o">(</span><span class="n">noRepos</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">ShadowToast</span><span class="o">.</span><span class="na">getTextOfLatestToast</span><span class="o">()).</span><span class="na">contains</span><span class="o">(</span><span class="s">"No repos :("</span><span class="o">);</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getListAdapter</span><span class="o">()).</span><span class="na">isEmpty</span><span class="o">();</span>
</code></pre>
</div>

<p>(You can find the full source of these examples and a full sample app on 
<a href="https://github.com/swanson/retrofit-demo/blob/master/Octodroid/test/com/swanson/octodroid/test/MainActivityTest.java">GitHub</a>).</p>

<p>One special detail to note, if you use the Mockito annotation when declaring
the captor,</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Captor</span>
<span class="kd">private</span> <span class="n">ArgumentCaptor</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Repository</span><span class="o">&gt;&gt;&gt;</span> <span class="n">cb</span><span class="o">;</span>
</code></pre>
</div>

<p>Make sure that somewhere in your setup, you do:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</code></pre>
</div>

<hr />

<p>This approach to testing hits all the marks in my book: fast, robust, and easy
to work with. It has allowed us to easily test rare edge cases (session timeout,
server down for maintenance, extraordinary values) in my current project and
achieve a high level of confidence that our app is working.</p>

<p>While this example is specific to a certain stack (Android, Robolectric,
Retrofit, Mockito), a similar approach can be applied to nearly any application.</p>

<p>Happy testing!</p>

</div>      

  
    <hr class="fin"/>
  
</article>


  <footer>
  <div id="bio">
    <div id="bio-image">
      <img src="/static/mugshot.jpg" alt="Matt Swanson">
    </div>
    
    <div id="bio-text">
      <p>Hi. I'm <b>Matt Swanson</b>.</p>
      <p>I do things and sometimes write about it here. I'm a Software Engineer from Indiana and I ship code at <a href="http://www.sep.com/">SEP</a>.</p>
      
      <div id="bio-social">
        <strike>Stalk</strike> Follow me:
<div id="social-links">
  <a title="swanson on Github" href="http://github.com/swanson/"><i class="fa fa-github-square"></i></a>
  <a title="swanson on Hacker News" href="http://news.ycombinator.com/user?id=swanson"><i class="fa fa-hacker-news"></i></a>
  <a title="_swanson on Twitter" href="http://twitter.com/_swanson"><i class="fa fa-twitter-square"></i></a>
  <a title="RSS feed" id="rss" href="/atom.xml"><i class="fa fa-rss-square"></i></a>
</div>
      </div>
    </div>
  </div>

  
  <aside>
    <h3>Further reading</h3>
    <ul class="posts">
      
        
        
          
            <li><a href="/blog/2014/06/02/android-form-models.html">Extracting Form Models in Android</a></li>
          
        
          
            <li><a href="/blog/2014/04/07/durable-android-rest-clients.html">Durable Android REST Clients</a></li>
          
        
          
            <li><a href="/blog/2014/02/24/integration-testing-rest-apis-for-android.html">Integration Testing against REST APIs in Android</a></li>
          
        
      
    </ul>
  </aside>
  
</footer>

<div id="fine-print">
  <p>
    built with <a href="#">&hearts;</a>, <a href="http://jekyllrb.com/">Jekyll</a>, and <a href="https://github.com/swanson/swanson.github.com">GitHub Pages</a> &mdash; read the <a href="/legal">fine print</a>
  </p>
</div>

  </section>

  
</body>
</html>
