---
title:  "Geofence"
date:   2018-01-08
author: Ankur Kumari
categories:
- blog
tags:
- android
---


### Geofence:

Refers to virtual perimeter created around defined locations with some specified radius in which we want to track the user for defined locations.

When to Use: When any Application requires the functionality to notify user that he/she entering or leaving the geofence areas.

### How to use:
(for references links are given at bottom of blog)
##### To use Geofence in your Application you need some steps to follow:

* Initially implement your location functionality, hope you already did it.
* Firstly create GeofencingClient in this way :
   ```
    mGeofencingClient = LocationServices.getGeofencingClient(context);
   ```
  This class is the main entry point for interacting with the geofencing APIs.

* Create Geofence: Create a list in which you can add a number of geofences you required to notify.
Pass latitude, longitude for all geofence locations you want to create.
  ```
   mGeofenceList.add(new Geofence.Builder()
   // Set the request ID of the geofence. This is a string to identify this
   // geofence.
   .setRequestId(Constants.GEOFENCE_ID)
   .setCircularRegion(
           latLng.latitude,
           latLng.longitude,
           radius
       )
   .setExpirationDuration(Geofence.NEVER_EXPIRE)
   .setTransitionTypes(Geofence.GEOFENCE_TRANSITION_ENTER | Geofence.GEOFENCE_TRANSITION_EXIT)
   .build());
    ```

* Add created gepfences list to GeofencingClient
  ```
   mGeofencingClient.addGeofences(getGeofencingRequest(), pendingIntent)
       .addOnSuccessListener(mContext, new OnSuccessListener<Void>() {
           @Override
           public void onSuccess(Void aVoid) {
           }
       })
       .addOnFailureListener(mContext, new OnFailureListener() {
           @Override
           public void onFailure(@NonNull Exception e) {
           }
       });
  ```

    For above you need to create the geofence request (in GeofencingRequest pass list of geofences)

    ```
      GeofencingRequest.Builder builder = new GeofencingRequest.Builder();
      builder.setInitialTrigger(GeofencingRequest.INITIAL_TRIGGER_ENTER | GeofencingRequest.INITIAL_TRIGGER_EXIT |GeofencingRequest.INITIAL_TRIGGER_DWELL);
      builder.addGeofences(mGeofenceList);
      return builder.build();
  ```
  And require the pending intent so for any trigger for enter and exit, you will get the call back

    ```
      private PendingIntent getGeofencePendingIntent() {
         if (mGeofencePendingIntent != null) {
           return mGeofencePendingIntent;
         }
        Intent intent = new Intent(this, GeofenceTransitionsIntentService.class);
        mGeofencePendingIntent = PendingIntent.getService(this, 0, intent, PendingIntent.
           FLAG_UPDATE_CURRENT);
        return mGeofencePendingIntent;
      }
    ```

   For callback update regarding that user is inside/outside the Geofence you need to create an intent service:
Inside onHandleIntent (Intent intent)  you can handle your response as you want like you can show notification to user.
  ```
   GeofencingEvent geofencingEvent = GeofencingEvent.fromIntent(intent);
       if (geofencingEvent.hasError()) {
           return;
       }
       // Get the transition type.
       int geofenceTransition = geofencingEvent.getGeofenceTransition();
       if (geofenceTransition == Geofence.GEOFENCE_TRANSITION_ENTER ||
               geofenceTransition == Geofence.GEOFENCE_TRANSITION_EXIT) {
           // Get the geofences that were triggered. A single event can trigger
           // multiple geofences.
           List<Geofence> triggeringGeofences = geofencingEvent.getTriggeringGeofences();
           // Get the transition details as a String.
           String geofenceTransitionDetails = getGeofenceTransitionDetails(
                   this,
                   geofenceTransition,
                   triggeringGeofences
           );
          //show notification here
           sendNotification(geofenceTransitionDetails);
       } else {
        }
  ```

  Get details in string format:
  ```
    private String getGeofenceTransitionDetails(
            Context context,
            int geofenceTransition,
            List<Geofence> triggeringGeofences) {

        String geofenceTransitionString = getTransitionString(geofenceTransition);

        // Get the Ids of each geofence that was triggered.
        ArrayList triggeringGeofencesIdsList = new ArrayList();
        for (Geofence geofence : triggeringGeofences) {
            triggeringGeofencesIdsList.add(geofence.getRequestId());
        }
        String triggeringGeofencesIdsString = TextUtils.join(", ", triggeringGeofencesIdsList);

        return geenofceTransitionString + ": " + triggeringGeofencesIdsString;
        }

      private String getTransitionString(int transitionType) {
         switch (transitionType) {
            case Geofence.GEOFENCE_TRANSITION_ENTER:
                return "transition - enter";
            case Geofence.GEOFENCE_TRANSITION_EXIT:
                return "transition - exit";
            default:
                return "unknown transition";
          }
       }
  ```

 #### Don't forget:
* to add service element in manifest
  ```
   <application
    android:allowBackup="true">
    ...
    <service android:name=".GeofenceTransitionsIntentService"/>
   <application/>
  ```
 * Add locations permission for runtime also.

#### For detail refer:
[Developers Link]

[Developers Link]: <https://developer.android.com/training/location/geofencing.html>
